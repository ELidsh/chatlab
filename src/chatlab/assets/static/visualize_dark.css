/* Basic Reset */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: sans-serif; background-color: #1e1e1e; color: #ececec; margin: 0; padding: 10px; line-height: 1.5; }

/* Metadata Styling (Conversation Level) */
.metadata { background-color: #2a2a2a; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #444; }
.metadata h2 { margin-top: 0; font-size: 1.2em; color: #f1f1f1; word-wrap: break-word; }
.metadata p { margin: 5px 0; line-height: 1.4; display: block; }
.metadata strong { color: #fff; }
.metadata hr.metadata-divider { border: 0; height: 1px; background-color: #444; margin: 15px 0; display: block; width: 100%; }
.metadata em { font-style: italic; opacity: 0.85;}
.metadata a { color: #6EB5FF; text-decoration: none; } /* Dark theme link color */
.metadata a:hover { text-decoration: underline; }

/* Main Conversation Grid Layout (Annotations Enabled) */
.conversation-grid {
    display: grid;
    grid-template-columns: 1fr 5px 250px; /* Message | Resizer | Annotation */
    gap: 0 10px;
    border: 1px solid #444;
    border-radius: 8px;
    margin-top: 15px;
    position: relative;
    overflow: visible;
}

/* Grid Cells */
.grid-col-message, .grid-col-resizer, .grid-col-annotation {
    padding: 0; margin-bottom: 10px; align-self: start; min-width: 0;
}
.grid-col-message { padding-left: 10px; padding-right: 5px; position: relative; }
.grid-col-annotation { padding-left: 5px; padding-right: 10px; position: relative; }
.grid-col-resizer { padding: 0; }

/* Resizer Handle */
.resizer-handle {
    position: absolute; top: 0; bottom: 0; width: 5px; background-color: #444;
    border-left: 1px solid #555; border-right: 1px solid #555; cursor: col-resize;
    z-index: 10; transition: background-color 0.2s ease;
}
.resizer-handle:hover { background-color: #555; }
#dragHandle { /* JS sets left position */ }


/* === FINAL Turn Layout v6 === */

/* Turn Container - Use align-items: flex-start */
.turn {
    display: flex;
    flex-direction: row;
    align-items: flex-start; /* Align top of prefix with top of main-content */
    gap: 10px;
    width: 100%;
    margin-bottom: 10px;
}

/* Left part: Turn Number and Avatar */
.turn-prefix {
    display: flex;
    flex-direction: row;
    align-items: center; /* Vertically center number relative to avatar */
    gap: 10px;
    flex-shrink: 0;
    margin-top: 1.5em;
    /* No margin-top needed */
}
.turn-number {
    font-weight: bold;
    color: #aaa; /* Dark theme number color */
    min-width: 20px;
    text-align: center;
    line-height: 1;
}
.avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: block;
}

/* Right part: Metadata and Message Bubble */
.turn-main-content {
    display: flex; /* Use flex for main content (optional, could be block) */
    flex-direction: column;
    flex-grow: 1;
    min-width: 0;
    position: relative; /* Needed for absolute positioning of metadata */
    /* No padding-top needed */
}

/* Metadata Row - Positioned absolutely */
.turn-metadata-row {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1.5em; /* Fixed height */
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    font-size: 0.8em;
    padding: 0 5px;
    box-sizing: border-box;
    overflow: hidden;
    z-index: 1;
    pointer-events: none;
    color: #aaa; /* Dark theme color */
}
.metadata-left { text-align: left; font-weight: bold; }
.metadata-right { text-align: right; }
.indicator { font-weight: bold; margin-left: 4px; margin-right: 4px; pointer-events: auto; }
.indicator:first-child { margin-left: 0; }
.indicator:last-child { margin-right: 0; }
.indicator-code { color: #c58af9; } /* Adjusted for dark */
.indicator-toxic { color: #ff7b7b; } /* Adjusted for dark */
.indicator-pii { color: #ffcc66; } /* Adjusted for dark */

/* Message Bubble - Add margin-top for metadata space */
.message-bubble {
    padding: 9px 14px; /* Normal padding */
    /* padding-top: 1.5em; Removed internal padding */
    margin-top: 1.5em; /* Add margin matching metadata height */
    border-radius: 15px; /* Applies to all corners */
    word-wrap: break-word;
    border: 1px solid transparent;
    line-height: 1.5;
    width: 100%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    position: relative;
    z-index: 0;
}
.message-bubble:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.4); border-color: #6a7aaf; }

/* Role-specific bubble styling */
.user .message-bubble {
    background-color: #3A4A7D;
    color: #e0e0ff;
}
.assistant .message-bubble {
    background-color: #474747;
    color: #e0e0e0;
}

/* === END FINAL Turn Layout v6 === */


/* Annotation Area Styling */
.annotation-container {
    width: 100%; display: flex; flex-direction: column; align-items: center;
    position: relative;
     padding-top: 1.5em; /* Match bubble margin-top */
}
/* ... Keep rest of annotation styles ... */
.add-annotation-btn { /* ... */ }
.add-annotation-btn:hover { /* ... */ }
.add-annotation-btn:active { /* ... */ }
.annotation-toolbar { /* ... */ }
.annotation-toolbar button, .annotation-toolbar select { /* ... */ }
.annotation-toolbar button:hover, .annotation-toolbar select:hover { /* ... */ }
.annotation-toolbar button.active { /* ... */ }
.annotation-toolbar select { /* ... */ }
.annotation-toolbar select option { /* ... */ }
.annotation-toolbar select[data-command="hiliteColor"] option { /* ... */ }
.annotation-toolbar select[data-command="hiliteColor"] option[value="transparent"] { /* ... */ }
.delete-annotation-btn { /* ... */ }
.delete-annotation-btn:hover { /* ... */ }
.annotation-textbox { /* ... */ }
.annotation-textbox:focus { /* ... */ }
.annotation-textbox[contenteditable=true]:empty:before { /* ... */ }
.annotation-textbox ul { /* ... */ }
.annotation-textbox li { /* ... */ }
.annotation-container.editing .add-annotation-btn { display: none; }
.annotation-container.editing .annotation-textbox { display: block; }
.annotation-container.editing .delete-annotation-btn { display: block; }
.annotation-container.editing { align-items: flex-start; }


/* Markdown Element Styling (Dark Theme) */
/* ... Keep all markdown styles ... */
.message table { /* ... */ }
.message th, .message td { /* ... */ }
.message th { /* ... */ }
.message pre { /* ... */ }
.message code:not(pre code) { /* ... */ }
.message pre code { /* ... */ }
.message ul, .message ol {
    margin: 10px 0 10px 20px; /* Top/Bottom margin + Left Margin */
    padding-left: 15px;      /* Left Padding (adjust as needed for bullet position) */
    /* Ensure list style is not none if reset removed it */
    list-style-position: outside; /* Or inside, depending on desired look */
}
/* Add back default list style types if your reset removed them */
.message ul {
    list-style-type: disc;
}
.message ol {
    list-style-type: decimal;
}

.message li {
    margin-bottom: 5px;
}
.message blockquote { /* ... */ }
.message h1, .message h2, .message h3, .message h4, .message h5, .message h6 { /* ... */ }
.message p { /* ... */ }
.message p:last-child { /* ... */ }

/* Styles for base_html mode (no annotations) */
body:not(.annotation-active) .conversation-grid {
    display: block !important; border: none !important; margin-top: 0 !important; padding: 0 !important;
}
body:not(.annotation-active) .grid-col-message { padding-left: 0 !important; padding-right: 0 !important; }
body:not(.annotation-active) .turn { padding-left: 10px; padding-right: 10px; }